services:
  traefik:
    image: traefik:v2.10
    env_file:
      - ./salonease-mvp/backend/.env
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.myresolver.acme.tlschallenge=true"
      - "--certificatesresolvers.myresolver.acme.email=admin@zenmanager.eu"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--entrypoints.websecure.forwardedHeaders.trustedIPs=173.245.48.0/20,103.21.244.0/22,103.22.200.0/22,103.31.4.0/22,141.101.64.0/18,108.162.192.0/18,190.93.240.0/20,188.114.96.0/20,197.234.240.0/22,198.41.128.0/17,162.158.0.0/15,104.16.0.0/13,104.24.0.0/14,172.64.0.0/13,131.0.72.0/22"
      - "--entrypoints.websecure.proxyProtocol.trustedIPs=173.245.48.0/20,103.21.244.0/22,103.22.200.0/22,103.31.4.0/22,141.101.64.0/18,108.162.192.0/18,190.93.240.0/20,188.114.96.0/20,197.234.240.0/22,198.41.128.0/17,162.158.0.0/15,104.16.0.0/13,104.24.0.0/14,172.64.0.0/13,131.0.72.0/22"
      - "--log.level=ERROR"
      - "--accesslog=true"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./letsencrypt:/letsencrypt"
    networks:
      - app-network
    restart: unless-stopped

  frontend:
    image: ghcr.io/man0l/salonease:frontend-latest
    env_file:
      - ./salonease-mvp/frontend/.env
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`zenmanager.eu`) && !PathPrefix(`/api`) && !PathPrefix(`/uploads`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=myresolver"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"
      - "com.centurylinklabs.watchtower.enable=true"
    networks:
      - app-network
    depends_on:
      - backend
    restart: unless-stopped

  backend:
    image: ghcr.io/man0l/salonease:backend-latest
    env_file:
      - ./salonease-mvp/backend/.env
    environment:
      - NODE_ENV=production
      - FRONTEND_URL=https://zenmanager.eu
      - CORS_ORIGIN=https://zenmanager.eu
      - PORT=5000
    labels:
      - "traefik.enable=true"
      # Main API router
      - "traefik.http.routers.backend.rule=Host(`zenmanager.eu`) && PathPrefix(`/api`)"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls.certresolver=myresolver"
      
      # Static files router for uploads
      - "traefik.http.routers.backend-uploads.rule=Host(`zenmanager.eu`) && PathPrefix(`/uploads`)"
      - "traefik.http.routers.backend-uploads.entrypoints=websecure"
      - "traefik.http.routers.backend-uploads.tls.certresolver=myresolver"
      - "traefik.http.routers.backend-uploads.service=backend-service"
      
      - "traefik.http.services.backend.loadbalancer.server.port=5000"
      - "traefik.http.middlewares.strip-api.stripprefix.prefixes=/api"
      - "traefik.http.middlewares.cors.headers.accesscontrolallowmethods=GET,POST,PUT,DELETE,OPTIONS"
      - "traefik.http.middlewares.cors.headers.accesscontrolalloworiginlist=https://zenmanager.eu"
      - "traefik.http.middlewares.cors.headers.accesscontrolallowheaders=*"
      - "traefik.http.middlewares.cors.headers.accesscontrolmaxage=100"
      - "traefik.http.middlewares.cors.headers.addvaryheader=true"
      - "traefik.http.services.backend-service.loadbalancer.server.port=5000"
      - "traefik.http.services.backend-service.loadbalancer.passHostHeader=true"
      - "traefik.http.routers.backend.service=backend-service"
      - "com.centurylinklabs.watchtower.enable=true"
    networks:
      - app-network
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    volumes:
      - ./salonease-mvp/backend/uploads:/app/uploads

  python-runner:
    image: ghcr.io/man0l/cold-email-ninja:prod
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    networks:
      - app-network
    restart: unless-stopped

  db:
    image: pgvector/pgvector:pg13
    command: postgres -c wal_level=logical
    env_file:
      - ./salonease-mvp/backend/.env
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-pgvector.sql:/docker-entrypoint-initdb.d/init-pgvector.sql:ro
      - ./supabase/init:/docker-entrypoint-initdb.d/supabase:ro
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  supabase-db17:
    image: supabase/postgres:17.6.1.074
    entrypoint: /docker-custom/db-entrypoint.sh
    command: postgres -c listen_addresses='*' -c shared_preload_libraries='pg_cron,pg_net' -c cron.database_name=salonease -c pg_net.database_name=salonease
    env_file:
      - ./supabase/.env
    volumes:
      - supabase_pg17_data:/var/lib/postgresql/data
      - ./supabase/db-entrypoint.sh:/docker-custom/db-entrypoint.sh:ro
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  supabase-kong:
    image: kong:2.1
    env_file:
      - ./supabase/.env
    environment:
      - KONG_DATABASE=off
      - KONG_DECLARATIVE_CONFIG=/var/lib/kong/kong.yml
      - KONG_DNS_ORDER=LAST,A,CNAME
      - KONG_PLUGINS=request-transformer,cors,key-auth,acl
    volumes:
      - ./supabase/kong.yml:/var/lib/kong/kong.yml:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.supabase-api.rule=Host(`api.zenmanager.eu`)"
      - "traefik.http.routers.supabase-api.entrypoints=websecure"
      - "traefik.http.routers.supabase-api.tls.certresolver=myresolver"
      - "traefik.http.services.supabase-api.loadbalancer.server.port=8000"
      - "com.centurylinklabs.watchtower.enable=true"
    networks:
      - app-network
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

  supabase-auth:
    image: supabase/gotrue:v2.2.12
    env_file:
      - ./supabase/.env
    networks:
      - app-network
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

  supabase-rest:
    image: postgrest/postgrest:v9.0.0
    env_file:
      - ./supabase/.env
    networks:
      - app-network
    depends_on:
      db:
        condition: service_healthy
      supabase-db17:
        condition: service_healthy
    restart: unless-stopped

  supabase-realtime:
    image: supabase/realtime:v0.21.0
    env_file:
      - ./supabase/.env
    environment:
      - PORT=4000
    command: >
      bash -c "./prod/rel/realtime/bin/realtime eval Realtime.Release.migrate
      && ./prod/rel/realtime/bin/realtime start"
    networks:
      - app-network
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

  supabase-storage:
    image: supabase/storage-api:v0.10.0
    env_file:
      - ./supabase/.env
    volumes:
      - supabase_storage:/var/lib/storage
    networks:
      - app-network
    depends_on:
      db:
        condition: service_healthy
      supabase-rest:
        condition: service_started
    restart: unless-stopped

  supabase-meta:
    image: supabase/postgres-meta:v0.95.2
    env_file:
      - ./supabase/.env
    networks:
      - app-network
    depends_on:
      db:
        condition: service_healthy
      supabase-db17:
        condition: service_healthy
    restart: unless-stopped

  studio-pgmeta-proxy:
    image: python:3.11-slim
    command: python /app/pgmeta-proxy.py
    environment:
      - PG_META_URL=http://supabase-meta:8080
      - PORT=8082
    volumes:
      - ./supabase/pgmeta-proxy.py:/app/pgmeta-proxy.py:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.studio-pgmeta-query.rule=Host(`studio.zenmanager.eu`) && Path(`/api/platform/pg-meta/default/query`)"
      - "traefik.http.routers.studio-pgmeta-query.entrypoints=websecure"
      - "traefik.http.routers.studio-pgmeta-query.tls.certresolver=myresolver"
      - "traefik.http.routers.studio-pgmeta-query.priority=100"
      - "traefik.http.routers.studio-pgmeta-query.middlewares=supabase-studio-auth"
      - "traefik.http.services.studio-pgmeta-query.loadbalancer.server.port=8082"
    networks:
      - app-network
    depends_on:
      supabase-meta:
        condition: service_started
    restart: unless-stopped

  supabase-functions:
    image: supabase/edge-runtime:v1.69.6
    env_file:
      - ./supabase/.env
    environment:
      - SUPABASE_URL=http://supabase-kong:8000
      - SUPABASE_ANON_KEY=$${ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=$${SERVICE_ROLE_KEY}
      - SUPABASE_DB_URL=postgresql://postgres:$${POSTGRES_PASSWORD}@db:5432/$${POSTGRES_DB}
      - JWT_SECRET=$${JWT_SECRET}
      - VERIFY_JWT=false
    command:
      - start
      - --main-service
      - /home/deno/functions/main
    volumes:
      - ./supabase/functions:/home/deno/functions:rw
    networks:
      - app-network
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

  supabase-studio:
    image: supabase/studio:latest
    env_file:
      - ./supabase/.env
    environment:
      - PORT=3000
      - EDGE_FUNCTIONS_MANAGEMENT_FOLDER=/tmp/edge-functions
      - EDGE_FUNCTIONS_URL=http://supabase-functions:9000
      - POSTGRES_PASSWORD=$${POSTGRES_PASSWORD}
      - AUTH_JWT_SECRET=$${JWT_SECRET}
      - SNIPPETS_MANAGEMENT_FOLDER=/tmp/snippets
      - STUDIO_PG_META_URL=http://studio-pgmeta-proxy:8082
    volumes:
      - ./supabase/studio.env:/app/apps/studio/.env:ro
      - ./supabase/functions:/tmp/edge-functions:ro
    healthcheck:
      disable: true
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.supabase-studio.rule=Host(`studio.zenmanager.eu`)"
      - "traefik.http.routers.supabase-studio.entrypoints=websecure"
      - "traefik.http.routers.supabase-studio.tls.certresolver=myresolver"
      - "traefik.http.middlewares.supabase-studio-auth.basicauth.users=admin:$$2y$$05$$ttwQ1gfOS3bIpnG7k6SiHOT3f7iLDIqW1cl/KtKtPXZIu0AcOefUC"
      - "traefik.http.routers.supabase-studio.middlewares=supabase-studio-auth"
      - "traefik.http.services.supabase-studio.loadbalancer.server.port=3000"
      - "com.centurylinklabs.watchtower.enable=true"
    networks:
      - app-network
    depends_on:
      supabase-meta:
        condition: service_started
      supabase-functions:
        condition: service_started
      supabase-kong:
        condition: service_started
    restart: unless-stopped

  pgadmin:
    image: dpage/pgadmin4
    env_file:
      - ./salonease-mvp/backend/.env
    volumes:
      - pgadmin_data:/var/lib/pgadmin
      - pgadmin_logs:/var/log/pgadmin
      - ./pgadmin/config_distro.py:/pgadmin4/config_distro.py
    environment:
      - PGADMIN_LISTEN_PORT=80
      - PGADMIN_CONFIG_SERVER_MODE=True
      - PGADMIN_CONFIG_DEFAULT_SERVER=0.0.0.0
    labels:
      - "traefik.enable=true"
      
      # Simplified router configuration
      - "traefik.http.routers.pgadmin.rule=Host(`pgadmin.zenmanager.eu`)"
      - "traefik.http.routers.pgadmin.entrypoints=websecure"
      - "traefik.http.routers.pgadmin.tls.certresolver=myresolver"
      
      # Service configuration
      - "traefik.http.services.pgadmin.loadbalancer.server.port=80"
      
      # Basic security headers
      - "traefik.http.middlewares.pgadmin-headers.headers.sslredirect=true"
      - "traefik.http.middlewares.pgadmin-headers.headers.stsSeconds=315360000"
      - "traefik.http.middlewares.pgadmin-headers.headers.forceSTSHeader=true"
      
      # Apply the middleware to the router
      - "traefik.http.routers.pgadmin.middlewares=pgadmin-headers"

    networks:
      - app-network
    depends_on:
      - db
    restart: unless-stopped
  watchtower:
    image: containrrr/watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_LABEL_ENABLE=true
    command: --interval 300 --label-enable
    networks:
      - app-network
    restart: unless-stopped
  n8n:
    image: n8nio/n8n:latest
    env_file:
      - ./salonease-mvp/backend/.env
    environment:
      - DB_TYPE=postgresdb
      - N8N_HOST=n8n.zenmanager.eu
      - N8N_PROTOCOL=https
      - N8N_PORT=5678
      - WEBHOOK_URL=https://n8n.zenmanager.eu/
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - NODE_FUNCTION_ALLOW_EXTERNAL=uuid
      - NODE_FUNCTION_ALLOW_BUILTIN=*
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`n8n.zenmanager.eu`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls.certresolver=myresolver"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
      
      # WebSocket support middleware
      #- "traefik.http.middlewares.websocket-headers.headers.customrequestheaders.Origin=n8n.zenmanager.eu"
      #- "traefik.http.routers.n8n.middlewares=websocket-headers"
      
      - "com.centurylinklabs.watchtower.enable=true"
    networks:
      - app-network
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - n8n_data:/home/node/.n8n
    restart: unless-stopped


networks:
  app-network:
    driver: bridge

volumes:
  postgres_data:
  pgadmin_data:
  pgadmin_logs: 
  n8n_data:
  supabase_storage:
  supabase_pg17_data:
